---
title: 欠損値の除外・穴埋め・補間
free: true
---
本章では、様々なデータ分析に際し、頻繁に存在している欠損値の扱い方を紹介します。欠損値とは、本来あるべきデータが欠けている状態を指します。例えば、アンケート調査で回答が抜けている場合や、計測機器の故障によってデータが取得できなかった場合などが挙げられます。

欠損値が存在するデータに対してそのまま分析を進めてしまうと、誤った結果が導かれる可能性があります。そのため、欠損値に対して適切な処理を行うことが重要です。

サンプルデータ

| |lin_missing|sq_missing|rand_missing|
|---|---|---|---|
|0|NaN|0.0|38.737865|
|1|1.0|NaN|NaN|
|2|NaN|4.0|53.613001|
|3|NaN|NaN|NaN|
|4|4.0|16.0|48.937626|
|...|...|...|...|
|95|NaN|NaN|NaN|
|96|NaN|9216.0|95.785956|
|97|NaN|NaN|NaN|
|98|NaN|9604.0|39.600509|
|99|NaN|NaN|NaN|
> 100 rows × 3 columns


 `lin_missing` は欠損箇所が連続しており、`sq_missing` と `rand_missing` では欠損箇所は連続していません。

## 欠損値が含まれる行を除外するdropnaメソッド
dropnaは引数howで条件を指定することが可能です。引数how='any'を指定すると1つでも欠損値がある行は除外されます。標準値は'any'です。
```python
df_drop = df.dropna() # df.dropna(how='any')と同じ

df_drop
```

| |lin_missing|sq_missing|rand_missing|
|---|---|---|---|
|4|4.0|16.0|48.937626|
|8|8.0|64.0|48.625715|
|26|26.0|676.0|43.908755|
|34|34.0|1156.0|21.945200|
|64|64.0|4096.0|19.866293|
|76|76.0|5776.0|89.793200|
|88|88.0|7744.0|72.156991|

引数how='all'を指定すると、行中すべてが欠損している行のみが除外されます。

## 欠損値穴埋め fillna メソッド
```python
df_fill = df.fillna(0)

df_fill
```

|     | lin_missing | sq_missing | rand_missing |
| --- | ----------- | ---------- | ------------ |
| 0   | 0.0         | 0.0        | 38.737865    |
| 1   | 1.0         | 0.0        | 0.000000     |
| 2   | 0.0         | 4.0        | 53.613001    |
| 3   | 0.0         | 0.0        | 0.000000     |
| 4   | 4.0         | 16.0       | 48.937626    |
| ... | ...         | ...        | ...          |
| 95  | 0.0         | 0.0        | 0.000000     |
| 96  | 0.0         | 9216.0     | 95.785956    |
| 97  | 0.0         | 0.0        | 0.000000     |
| 98  | 0.0         | 9604.0     | 39.600509    |
| 99  | 0.0         | 0.0        | 0.000000     |

### 列ごとに異なる値で穴埋めする場合は dict
```python
df_fill = df.fillna({
    'lin_missing': 99,
    'sq_missing': 9999,
    'rand_missing': -1
})

df_fill
```

| |lin_missing|sq_missing|rand_missing|
|---|---|---|---|
|0|99.0|0.0|38.737865|
|1|1.0|9999.0|-1.000000|
|2|99.0|4.0|53.613001|
|3|99.0|9999.0|-1.000000|
|4|4.0|16.0|48.937626|
|...|...|...|...|
|95|99.0|9999.0|-1.000000|
|96|99.0|9216.0|95.785956|
|97|99.0|9999.0|-1.000000|
|98|99.0|9604.0|39.600509|
|99|99.0|9999.0|-1.000000|

### 列ごとの平均値で穴埋めする場合は mean
```python
df_fill = df.fillna(df.mean())

df_fill
```

| |lin_missing|sq_missing|rand_missing|
|---|---|---|---|
|0|35.75|0.0|38.737865|
|1|1.00|3234.0|48.363477|
|2|35.75|4.0|53.613001|
|3|35.75|3234.0|48.363477|
|4|4.00|16.0|48.937626|
|...|...|...|...|
|95|35.75|3234.0|48.363477|
|96|35.75|9216.0|95.785956|
|97|35.75|3234.0|48.363477|
|98|35.75|9604.0|39.600509|
|99|35.75|3234.0|48.363477|

その他
- 中央値で穴埋めする場合は median
- 最大値で穴埋めする場合は max
- 最小値で穴埋めする場合は min

## 欠損値の補間 interpolateメソッド

固定値で穴埋めするのではなく、 周囲の値を使って欠損箇所を補間する場合は interpolate メソッドは引数methodに'linear'を interpolate メソッドを使用します。 指定することで線形補間を行います。引数limit_directionは補間を行う行の方向で あり、forwardを指定することで昇順に補間を行います。
サンプルでは列「lin_missing」は先頭行が欠損しているため、昇順方向では先頭行 は補間できていません。末尾行の欠損は、最後の有効値で補外されています。

```python
df_interpol = df.interpolate(method='linear', limit_direction='forward')

df_interpol
```

| |lin_missing|sq_missing|rand_missing|
|---|---|---|---|
|0|NaN|0.0|38.737865|
|1|1.0|2.0|46.175433|
|2|2.0|4.0|53.613001|
|3|3.0|10.0|51.275314|
|4|4.0|16.0|48.937626|
|...|...|...|...|
|95|88.0|9026.0|92.269276|
|96|88.0|9216.0|95.785956|
|97|88.0|9410.0|67.693232|
|98|88.0|9604.0|39.600509|
|99|88.0|9604.0|39.600509|

引数limit_directionに'backwardを指定すると、降順方向に補問を行います。列 「lin_missing |は今度は末尾行が補間されていません。
```python
df_interpol = df.interpolate(method='linear', limit_direction='backward')

df_interpol
```

|     | lin_missing | sq_missing | rand_missing |
| --- | ----------- | ---------- | ------------ |
| 0   | 1.0         | 0.0        | 38.737865    |
| 1   | 1.0         | 2.0        | 46.175433    |
| 2   | 2.0         | 4.0        | 53.613001    |
| 3   | 3.0         | 10.0       | 51.275314    |
| 4   | 4.0         | 16.0       | 48.937626    |
| ... | ...         | ...        | ...          |
| 95  | NaN         | 9026.0     | 92.269276    |
| 96  | NaN         | 9216.0     | 95.785956    |
| 97  | NaN         | 9410.0     | 67.693232    |
| 98  | NaN         | 9604.0     | 39.600509    |
| 99  | NaN         | NaN        | NaN          |

引数limit direction に both を指定することで、昇順方向にも降順方向にも補外が 行われます。
```python
df_interpol = df.interpolate(method='linear', limit_direction='both')

df_interpol
```

| |lin_missing|sq_missing|rand_missing|
|---|---|---|---|
|0|1.0|0.0|38.737865|
|1|1.0|2.0|46.175433|
|2|2.0|4.0|53.613001|
|3|3.0|10.0|51.275314|
|4|4.0|16.0|48.937626|
|...|...|...|...|
|95|88.0|9026.0|92.269276|
|96|88.0|9216.0|95.785956|
|97|88.0|9410.0|67.693232|
|98|88.0|9604.0|39.600509|
|99|88.0|9604.0|39.600509|

補外を使わず補間のみにするには、引数limit_area に insideを指定します。
```python
df_interpol = df.interpolate(method='linear', limit_direction='both', limit_area='inside')

df_interpol
```

| |lin_missing|sq_missing|rand_missing|
|---|---|---|---|
|0|NaN|0.0|38.737865|
|1|1.0|2.0|46.175433|
|2|2.0|4.0|53.613001|
|3|3.0|10.0|51.275314|
|4|4.0|16.0|48.937626|
|...|...|...|...|
|95|NaN|9026.0|92.269276|
|96|NaN|9216.0|95.785956|
|97|NaN|9410.0|67.693232|
|98|NaN|9604.0|39.600509|
|99|NaN|NaN|NaN|

直前の有効値をコピーするには)数methodに、直後の有効能をコピーするに はmethod に bfillを指定してください
```python
df_interpol = df.interpolate(method='ffill')  # ffilではlimit_directionにはbackwardやbothは指定できない

df_interpol
```

| |lin_missing|sq_missing|rand_missing|
|---|---|---|---|
|0|NaN|0.0|38.737865|
|1|1.0|0.0|38.737865|
|2|1.0|4.0|53.613001|
|3|1.0|4.0|53.613001|
|4|4.0|16.0|48.937626|
|...|...|...|...|
|95|88.0|8836.0|88.752596|
|96|88.0|9216.0|95.785956|
|97|88.0|9216.0|95.785956|
|98|88.0|9604.0|39.600509|
|99|88.0|9604.0|39.600509|

```python
df_interpol = df.interpolate(method='bfill')  # bfilではlimit_directionにはforkwardやbothは指定できない

df_interpol
```

|     | lin_missing | sq_missing | rand_missing |
| --- | ----------- | ---------- | ------------ |
| 0   | 1.0         | 0.0        | 38.737865    |
| 1   | 1.0         | 4.0        | 53.613001    |
| 2   | 4.0         | 4.0        | 53.613001    |
| 3   | 4.0         | 16.0       | 48.937626    |
| 4   | 4.0         | 16.0       | 48.937626    |
| ... | ...         | ...        | ...          |
| 95  | NaN         | 9216.0     | 95.785956    |
| 96  | NaN         | 9216.0     | 95.785956    |
| 97  | NaN         | 9604.0     | 39.600509    |
| 98  | NaN         | 9604.0     | 39.600509    |
| 99  | NaN         | NaN        | NaN          |

引数 method には'spline'を指定することでスプライン補間が、'polynominal' を指 定することで多項式近似補間が使用できます。これらを指定する場合は、合わせて 引数'order'に次数を指定する必要があります。
```python
df_interpol = df.interpolate(method='spline', order=2, limit_direction='both')

df_interpol
```

| |lin_missing|sq_missing|rand_missing|
|---|---|---|---|
|0|-1.384309e-15|0.0|38.737865|
|1|1.000000e+00|1.0|48.815538|
|2|2.000000e+00|4.0|53.613001|
|3|3.000000e+00|9.0|53.153719|
|4|4.000000e+00|16.0|48.937626|
|...|...|...|...|
|95|9.500000e+01|9025.0|96.339804|
|96|9.600000e+01|9216.0|95.785956|
|97|9.700000e+01|9409.0|76.719060|
|98|9.800000e+01|9604.0|39.600509|
|99|9.900000e+01|9801.0|-15.599760|

```python
df_interpol = df.interpolate(method='polynomial', order=2, limit_direction='both')

df_interpol
```

| |lin_missing|sq_missing|rand_missing|
|---|---|---|---|
|0|NaN|0.0|38.737865|
|1|1.0|1.0|48.804981|
|2|2.0|4.0|53.613001|
|3|3.0|9.0|53.161927|
|4|4.0|16.0|48.937626|
|...|...|...|...|
|95|NaN|9025.0|96.225349|
|96|NaN|9216.0|95.785956|
|97|NaN|9409.0|76.911009|
|98|NaN|9604.0|39.600509|
|99|NaN|NaN|NaN|


#
---
## sample code
> [section_4_2.ipynb](books/Pandas&Plotly/src/notebook/section_4_2.ipynb)

