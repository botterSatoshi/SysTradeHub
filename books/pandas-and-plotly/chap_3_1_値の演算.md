---
title: 値の演算
free: true
---
サンプルデータ

| |val1|val2|
|---|---|---|
|date|||
|---|---|---|
|2010-01-01|148.083426|481.382983|
|2010-01-02|117.490787|466.259767|
|2010-01-03|147.009196|474.221712|
|2010-01-04|150.086981|493.239400|
|2010-01-05|162.703330|491.120699|
|...|...|...|
|2020-12-27|1029.031359|3521.016894|
|2020-12-28|1026.100656|3593.560824|
|2020-12-29|1002.146012|3424.869380|
|2020-12-30|1014.642041|3445.015116|
|2020-12-31|1027.480381|3493.546177|

マスク
```pytohn
boolean_mask
```
>date
>2010-01-01     True
>2010-01-02     True
>2010-01-03     True
>2010-01-04    False
>2010-01-05    False
>              ...  
>2020-12-27    False
>2020-12-28    False
>2020-12-29    False
>2020-12-30    False
>2020-12-31    False
Name: val1, Length: 4018, dtype: bool


## マスクを使って値を代入する
mask関数は第1引数にboolean index、第2引数に代入する値を指定すると、trueの個所にのみ値を代入することができます。

```python
df_mask = df.mask(boolean_mask, -1)

df_mask
```

| |val1|val2|
|---|---|---|
|date|||
|---|---|---|
|2010-01-01|-1.000000|-1.000000|
|2010-01-02|-1.000000|-1.000000|
|2010-01-03|-1.000000|-1.000000|
|2010-01-04|150.086981|493.239400|
|2010-01-05|162.703330|491.120699|
|...|...|...|
|2020-12-27|1029.031359|3521.016894|
|2020-12-28|1026.100656|3593.560824|
|2020-12-29|1002.146012|3424.869380|
|2020-12-30|1014.642041|3445.015116|
|2020-12-31|1027.480381|3493.546177|

maskの第2引数を省略するとNaNになります。
```python
df_mask = df.mask(boolean_mask)

df_mask
```

| |val1|val2|
|---|---|---|
|date|||
|---|---|---|
|2010-01-01|NaN|NaN|
|2010-01-02|NaN|NaN|
|2010-01-03|NaN|NaN|
|2010-01-04|150.086981|493.239400|
|2010-01-05|162.703330|491.120699|
|...|...|...|
|2020-12-27|1029.031359|3521.016894|
|2020-12-28|1026.100656|3593.560824|
|2020-12-29|1002.146012|3424.869380|
|2020-12-30|1014.642041|3445.015116|
|2020-12-31|1027.480381|3493.546177|

### Falseのところだけに値を代入するには

where関数を使います。mask関数で [否定演算"~"](books/Pandas&Plotly/chap_2_1_DataFrameの部分選択.md#マスクに論理演算)を使っても同じです。
```python
df_where = df.where(boolean_mask, -1)   # df.mask(~boolean_mask, -1)と同じ

df_where
```

| |val1|val2|
|---|---|---|
|date|||
|---|---|---|
|2010-01-01|148.083426|481.382983|
|2010-01-02|117.490787|466.259767|
|2010-01-03|147.009196|474.221712|
|2010-01-04|-1.000000|-1.000000|
|2010-01-05|-1.000000|-1.000000|
|...|...|...|
|2020-12-27|-1.000000|-1.000000|
|2020-12-28|-1.000000|-1.000000|
|2020-12-29|-1.000000|-1.000000|
|2020-12-30|-1.000000|-1.000000|
|2020-12-31|-1.000000|-1.000000|

## 演算結果の列を追加する
[行, 列] の順 [chap_2_1_DataFrameの部分選択](books/Pandas&Plotly/chap_2_1_DataFrameの部分選択.md)
```python
df['feat1'] = df['val1'] * df['val2']
df['feat2'] = np.log(df['val2'])

df.head()
```

| |val1|val2|feat1|feat2|
|---|---|---|---|---|
|date|||||
|---|---|---|---|---|
|2010-01-01|148.083426|481.382983|71284.841343|6.176663|
|2010-01-02|117.490787|466.259767|54781.226971|6.144743|
|2010-01-03|147.009196|474.221712|69714.952737|6.161675|
|2010-01-04|150.086981|493.239400|74028.812646|6.200995|
|2010-01-05|162.703330|491.120699|79906.973278|6.196690|
`feat2`では対数変換を行った。numpyのlog関数を使った

## 行方向に値をずらした列を作成 shift関数
時系列データ解析において、過去の時刻の値を特徴量とする場合があります。
shift関数で行方向に値がずれた行を作成することができます。

```python
df['feat3'] = df['val1'].shift(1)
df['feat4'] = df['val1'].shift(2)

df.head()
```

|            | val1       | val2       | feat3      | feat4      |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| date       |            |            |            |            |
| 2010-01-01 | 148.083426 | 481.382983 | NaN        | NaN        |
| 2010-01-02 | 117.490787 | 466.259767 | 148.083426 | NaN        |
| 2010-01-03 | 147.009196 | 474.221712 | 117.490787 | 148.083426 |
| 2010-01-04 | 150.086981 | 493.239400 | 147.009196 | 117.490787 |
| 2010-01-05 | 162.703330 | 491.120699 | 150.086981 | 147.009196 |
feat3には 1日ずらしたval1
feat4には 2日ずらしたval1

### 前後での値の変動を出したい
時系列データでは、前後での値の変動が意味を持つ場合があります。差分系列を作成するには、元データからshiftした値を減算します。

1日前とのボラティリティ
```python
df['feat5'] = df['val1'] - df['val1'].shift(1)

df.head()
```

|            | val1       | val2       | feat3      | feat4      | feat5      |
| ---------- | ---------- | ---------- | ---------- | ---------- | ---------- |
| date       |            |            |            |            |            |
| 2010-01-01 | 148.083426 | 481.382983 | NaN        | NaN        | NaN        |
| 2010-01-02 | 117.490787 | 466.259767 | 148.083426 | NaN        | -30.592639 |
| 2010-01-03 | 147.009196 | 474.221712 | 117.490787 | 148.083426 | 29.518409  |
| 2010-01-04 | 150.086981 | 493.239400 | 147.009196 | 117.490787 | 3.077785   |
| 2010-01-05 | 162.703330 | 491.120699 | 150.086981 | 147.009196 | 12.616349  |

## データの値を累積した列を作成 cumsum関数
df.cumsum関数を使う事で簡単に累積特徴量を求めることができます。numpyのcumsum関数を使っても同じことができます。

```python
df['feat6'] = df['val2'].cumsum()

df.head()
```

|            | val1       | val2       | feat6       |
| ---------- | ---------- | ---------- | ----------- |
| date       |            |            |             |
| 2010-01-01 | 148.083426 | 481.382983 | 481.382983  |
| 2010-01-02 | 117.490787 | 466.259767 | 947.642751  |
| 2010-01-03 | 147.009196 | 474.221712 | 1421.864463 |
| 2010-01-04 | 150.086981 | 493.239400 | 1915.103863 |
| 2010-01-05 | 162.703330 | 491.120699 | 2406.224562 |

## 移動平均 rolling関数
移動平均とは、近傍の時間範囲で平均化すること
dfには rollingメソッドでRollingクラスのインスタンスを作成することができる。
Rollingインスタンス自体は表形式データではないことに注意してください。
Rollingインスタンスにmeanメソッドを使うことで移動平均が得られます。

以下のサンプルコードは3日間の移動平均を算出しています。
rollingメソッドは初期値では**後方移動平均**（普通のやつ）だが、
center=trueにすることで**中央移動平均**（現在を中心に過去から未来までの平均）が計算できます。
```python
df['smooth_val1'] = df['val1'].rolling(3).mean()
df['smooth_val2'] = df['val2'].rolling(3, center=True).mean()

df
```

| |val1|val2|smooth_val1|smooth_val2|
|---|---|---|---|---|
|date|||||
|---|---|---|---|---|
|2010-01-01|148.083426|481.382983|NaN|NaN|
|2010-01-02|117.490787|466.259767|NaN|473.954821|
|2010-01-03|147.009196|474.221712|137.527803|477.906960|
|2010-01-04|150.086981|493.239400|138.195655|486.193937|
|2010-01-05|162.703330|491.120699|153.266503|491.101692|
|...|...|...|...|...|
|2020-12-27|1029.031359|3521.016894|1011.627288|3483.898095|
|2020-12-28|1026.100656|3593.560824|1019.780682|3513.149032|
|2020-12-29|1002.146012|3424.869380|1019.092676|3487.815107|
|2020-12-30|1014.642041|3445.015116|1014.296236|3454.476891|
|2020-12-31|1027.480381|3493.546177|1014.756145|NaN|

#
---
## sample code
> [section_3_1.ipynb](books/Pandas&Plotly/src/notebook/section_3_1.ipynb)

