---
title: 自作関数を適用した操作
free: true
---
DataFrameに適用する自作関数は、列ごとに処理する場合と、複数列の値を組み合わせて処理を行う場合があります。

サンプルデータ

|       | carat | cut       | color | clarity | depth | table | price | x    | y    | z    |
| ----- | ----- | --------- | ----- | ------- | ----- | ----- | ----- | ---- | ---- | ---- |
| 0     | 0.23  | Ideal     | E     | SI2     | 61.5  | 55.0  | 326   | 3.95 | 3.98 | 2.43 |
| 1     | 0.21  | Premium   | E     | SI1     | 59.8  | 61.0  | 326   | 3.89 | 3.84 | 2.31 |
| 2     | 0.23  | Good      | E     | VS1     | 56.9  | 65.0  | 327   | 4.05 | 4.07 | 2.31 |
| 3     | 0.29  | Premium   | I     | VS2     | 62.4  | 58.0  | 334   | 4.20 | 4.23 | 2.63 |
| 4     | 0.31  | Good      | J     | SI2     | 63.3  | 58.0  | 335   | 4.34 | 4.35 | 2.75 |
| ...   | ...   | ...       | ...   | ...     | ...   | ...   | ...   | ...  | ...  | ...  |
| 53935 | 0.72  | Ideal     | D     | SI1     | 60.8  | 57.0  | 2757  | 5.75 | 5.76 | 3.50 |
| 53936 | 0.72  | Good      | D     | SI1     | 63.1  | 55.0  | 2757  | 5.69 | 5.75 | 3.61 |
| 53937 | 0.70  | Very Good | D     | SI1     | 62.8  | 60.0  | 2757  | 5.66 | 5.68 | 3.56 |
| 53938 | 0.86  | Premium   | H     | SI2     | 61.0  | 58.0  | 2757  | 6.15 | 6.12 | 3.74 |
| 53939 | 0.75  | Ideal     | D     | SI2     | 62.2  | 55.0  | 2757  | 5.83 | 5.87 | 3.64 |
53940 rows × 10 columns

## 列に対してそれぞれ独立に自作関数を適用
DataFrameの複数列に対してそれぞれ独立に自作関数を適用するには、**applymap**メソッドを使用します。applymapメソッドの引数に関数を与えると、各列に関数を作用させた結果を返します。

`x`, `y` の単位をmmからcmに変換する処理を mm_to_cm 関数として定義し、`x`, `y` の値を変換してみましょう
```python
def mm_to_cm(size):
    return size / 10.

df.loc[:, ['x', 'y']] = df.loc[:, ['x', 'y']].applymap(mm_to_cm)

df.head()
```

| |carat|cut|color|clarity|depth|table|price|x|y|z|
|---|---|---|---|---|---|---|---|---|---|---|
|0|0.23|Ideal|E|SI2|61.5|55.0|326|0.395|0.398|2.43|
|1|0.21|Premium|E|SI1|59.8|61.0|326|0.389|0.384|2.31|
|2|0.23|Good|E|VS1|56.9|65.0|327|0.405|0.407|2.31|
|3|0.29|Premium|I|VS2|62.4|58.0|334|0.420|0.423|2.63|
|4|0.31|Good|J|SI2|63.3|58.0|335|0.434|0.435|2.75|

`z`のみ変換する。1列のみ選択したSeriesはapplymap関数をもっていません
Seriesの場合は代わりに**map**関数を使用します。
```python
df.loc[:, 'z'] = df.loc[:, 'z'].map(mm_to_cm)   # df.loc[:, 'z'].applymap はエラーになる

df.head()
```

|     | carat | cut     | color | clarity | depth | table | price | x     | y     | z     |
| --- | ----- | ------- | ----- | ------- | ----- | ----- | ----- | ----- | ----- | ----- |
| 0   | 0.23  | Ideal   | E     | SI2     | 61.5  | 55.0  | 326   | 0.395 | 0.398 | 0.243 |
| 1   | 0.21  | Premium | E     | SI1     | 59.8  | 61.0  | 326   | 0.389 | 0.384 | 0.231 |
| 2   | 0.23  | Good    | E     | VS1     | 56.9  | 65.0  | 327   | 0.405 | 0.407 | 0.231 |
| 3   | 0.29  | Premium | I     | VS2     | 62.4  | 58.0  | 334   | 0.420 | 0.423 | 0.263 |
| 4   | 0.31  | Good    | J     | SI2     | 63.3  | 58.0  | 335   | 0.434 | 0.435 | 0.27  |

まぁこれくらいの変換なら自作関数を使わずとも
```python
df[['x', 'y', 'z']] /= 10.
```
これでいいんだけどね

## 複数列を使う関数を適用
複数列を組み合わせた複雑な処理に対応できす**apply**メソッドについて

- `cut`が「Premium」や「Ideal」の時は、点数：`('carat' + 1.) ** 2. - 1.`
- `cut`が「Good」や「Very Good」の時は、点数：`2. * 'carat'`
- `cut`が「Fair」の時は、点数を`'carat' + 1.`
とする。

このように`cut`と`carat`という複数の列を組み合わせる関数の場合には
DataFrameの**apply**メソッドを使って自作関数を適用します。
```python
def calc_point(record):
    if record['cut'] in ['Premium', 'Ideal']:
        point = (record['carat'] + 1.) ** 2. - 1.
    elif record['cut'] in ['Good', 'Very Good']:
        point = 2. * record['carat']
    else:   # 'Fair' の場合
        point = np.log(record['carat'] + 1.)

    return point


df['point'] = df.apply(calc_point, axis=1)

df.head()
```

| |carat|cut|color|clarity|depth|table|price|x|y|z|point|
|---|---|---|---|---|---|---|---|---|---|---|---|
|0|0.23|Ideal|E|SI2|61.5|55.0|326|0.395|0.398|0.243|0.5129|
|1|0.21|Premium|E|SI1|59.8|61.0|326|0.389|0.384|0.231|0.4641|
|2|0.23|Good|E|VS1|56.9|65.0|327|0.405|0.407|0.231|0.4600|
|3|0.29|Premium|I|VS2|62.4|58.0|334|0.420|0.423|0.263|0.6641|
|4|0.31|Good|J|SI2|63.3|58.0|335|0.434|0.435|0.275|0.6200|

#
---
## sample code
> [section_3_2.ipynb](books/Pandas&Plotly/src/notebook/section_3_2.ipynb)

